<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Godray â€¢ Messenger</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, orderBy, addDoc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const app = initializeApp({
      apiKey: "AIzaSyB1Dnku0qGEWxLS9R8Mz5neKSReAyuypBs",
      authDomain: "bakhresa-b6176.firebaseapp.com",
      projectId: "bakhresa-b6176",
      storageBucket: "bakhresa-b6176.firebasestorage.app",
      messagingSenderId: "676670596170",
      appId: "1:676670596170:web:e56892493c3e3b69d6b2b3"
    });

    const auth = getAuth(app);
    const db = getFirestore(app);

    let me = null;
    let activeChat = null;

    const loginBox = document.getElementById("loginBox");
    const appUI = document.getElementById("app");
    const userList = document.getElementById("userList");
    const chatName = document.getElementById("chatName");
    const messagesArea = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");

    // Login / Register
    window.login = async () => {
      const email = document.getElementById("email").value.trim();
      const pass = document.getElementById("pass").value;
      const username = document.getElementById("username").value.trim().toLowerCase().replace(/[^a-z0-9_]/g, "");
      
      if (!email || !pass || !username) return alert("Fill all fields");

      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch {
        await createUserWithEmailAndPassword(auth, email, pass);
      }
      
      await setDoc(doc(db, "users", auth.currentUser.uid), {
        username,
        email,
        online: true,
        lastSeen: serverTimestamp()
      }, { merge: true });
    };

    onAuthStateChanged(auth, async user => {
      if (!user) { loginBox.style.display = "flex"; appUI.style.display = "none"; return; }
      
      me = (await getDoc(doc(db, "users", user.uid))).data();
      loginBox.style.display = "none";
      appUI.style.display = "flex";
      document.getElementById("myName").textContent = "@" + me.username;

      // Keep online status
      const userRef = doc(db, "users", user.uid);
      setDoc(userRef, { online: true, lastSeen: serverTimestamp() }, { merge: true });
      window.onunload = () => setDoc(userRef, { online: false, lastSeen: serverTimestamp() }, { merge: true });

      loadUsers();
    });

    function loadUsers() {
      onSnapshot(query(collection(db, "users"), where("username", "!=", null)), snap => {
        userList.innerHTML = "";
        snap.forEach(d => {
          const u = d.data();
          const el = document.createElement("div");
          el.className = "user-item";
          el.innerHTML = `
            <div class="avatar">${u.username[0].toUpperCase()}</div>
            <div class="user-info">
              <div class="name">@${u.username}</div>
              <div class="status">${u.online ? "Online" : "Offline"}</div>
            </div>
            ${u.online ? '<i class="online-dot"></i>' : ''}
          `;
          el.onclick = () => openChat(u.username);
          userList.appendChild(el);
        });
      });
    }

    function openChat(username) {
      activeChat = username;
      chatName.textContent = "@" + username;
      messagesArea.innerHTML = "";
      loadMessages();
    }

    function chatId(a, b) { return a < b ? `${a}_${b}` : `${b}_${a}`; }

    function loadMessages() {
      if (!activeChat) return;
      const id = chatId(me.username, activeChat);
      onSnapshot(query(collection(db, "messages"), where("chatId", "==", id), orderBy("time")), snap => {
        messagesArea.innerHTML = "";
        snap.forEach(d => {
          const m = d.data();
          const bubble = document.createElement("div");
          bubble.className = `message ${m.from === me.username ? "sent" : "received"}`;
          bubble.innerHTML = `
            <div class="text">${m.text}</div>
            <div class="time">${new Date(m.time?.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
          `;
          messagesArea.appendChild(bubble);
        });
        messagesArea.scrollTop = messagesArea.scrollHeight;
      });
    }

    window.sendMessage = async () => {
      const text = messageInput.value.trim();
      if (!text || !activeChat) return;
      const id = chatId(me.username, activeChat);
      await addDoc(collection(db, "messages"), {
        chatId: id,
        from: me.username,
        to: activeChat,
        text,
        time: serverTimestamp()
      });
      messageInput.value = "";
    };

    messageInput.addEventListener("keypress", e => e.key === "Enter" && sendMessage());
  </script>
  <style>
    :root { --primary: #00ff9d; --bg: #000; --card: #111; --text: #fff; }
    body { margin:0; font-family: system-ui; background: var(--bg); color: var(--text); height:100vh; overflow:hidden; }
    #loginBox, #app { display:flex; height:100vh; }
    #loginBox { flex-direction:column; justify-content:center; align-items:center; background:linear-gradient(135deg,#000,#003322); }
    #loginBox input, #loginBox button { width:320px; padding:16px; margin:10px; border:none; border-radius:50px; font-size:1.1em; }
    #loginBox button { background:var(--primary); color:#000; font-weight:bold; cursor:pointer; }
    #app { display:none; }
    #sidebar { width:340px; background:#080808; border-right:1px solid #222; overflow-y:auto; }
    #header { padding:20px; text-align:center; border-bottom:1px solid #222; }
    #header h1 { margin:0; color:var(--primary); }
    #userList { padding:10px; }
    .user-item { display:flex; align-items:center; padding:14px; border-radius:12px; margin:6px 10px; cursor:pointer; transition:0.2s; position:relative; }
    .user-item:hover { background:#1a1a1a; }
    .avatar { width:50px; height:50px; border-radius:50%; background:var(--primary); color:#000; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:1.3em; margin-right:14px; }
    .user-info .name { font-weight:600; }
    .user-info .status { font-size:0.8em; opacity:0.7; }
    .online-dot { position:absolute; bottom:18px; left:48px; width:14px; height:14px; background:var(--primary); border:3px solid #000; border-radius:50%; }

    #chatArea { flex:1; display:flex; flex-direction:column; background:#0a0a0a; }
    #chatHeader { padding:20px; border-bottom:1px solid #222; font-size:1.4em; font-weight:600; color:var(--primary); }
    #messages { flex:1; overflow-y:auto; padding:20px; }
    .message { max-width:70%; margin:10px 0; clear:both; }
    .sent { float:right; }
    .received { float:left; }
    .message .text { padding:12px 18px; border-radius:18px; margin-bottom:4px; }
    .sent .text { background:var(--primary); color:#000; border-bottom-right-radius:4px; }
    .received .text { background:#222; border-bottom-left-radius:4px; }
    .message .time { font-size:0.7em; opacity:0.6; padding:0 18px; }

    #inputArea { padding:15px; background:#000; border-top:1px solid #222; display:flex; align-items:center; }
    #messageInput { flex:1; padding:16px 20px; border:none; border-radius:50px; background:#222; color:white; font-size:1em; }
    #sendBtn { margin-left:12px; width:50px; height:50px; border:none; border-radius:50%; background:var(--primary); color:#000; cursor:pointer; font-size:1.3em; }
  </style>
</head>
<body>

  <!-- Login -->
  <div id="loginBox">
    <h1 style="color:#00ff9d;font-size:3em;margin-bottom:30px">Godray</h1>
    <input id="email" placeholder="Email" type="email">
    <input id="pass" placeholder="Password" type="password">
    <input id="username" placeholder="Choose username (@godray)">
    <button onclick="login()">Enter Messenger</button>
  </div>

  <!-- Main App -->
  <div id="app">
    <div id="sidebar">
      <div id="header">
        <h1>Godray</h1>
        <div style="margin-top:10px">Logged in as <span id="myName" style="color:#00ff9d"></span></div>
      </div>
      <div id="userList"></div>
    </div>

    <div id="chatArea">
      <div id="chatHeader">Select a user to start chatting</div>
      <div id="messages"></div>
      <div id="inputArea">
        <input id="messageInput" placeholder="Type a message..." autocomplete="off">
        <button id="sendBtn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

</body>
</html>
