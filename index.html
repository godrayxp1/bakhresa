<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Godray Messenger</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB1Dnku0qGEWxLS9R8Mz5neKSReAyuypBs",
      authDomain: "bakhresa-b6176.firebaseapp.com",
      databaseURL: "https://bakhresa-b6176-default-rtdb.firebaseio.com",
      projectId: "bakhresa-b6176",
      storageBucket: "bakhresa-b6176.firebasestorage.app",
      messagingSenderId: "676670596170",
      appId: "1:676670596170:web:e56892493c3e3b69d6b2b3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let myId = null, peerId = null;
    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("msg");

    signInAnonymously(auth);
    onAuthStateChanged(auth, user => {
      if (!user) return;
      myId = user.uid;
      document.getElementById("login").style.display = "none";
      document.getElementById("chat").style.display = "block";
      document.getElementById("myId").textContent = myId.slice(0,12)+"...";
    });

    window.startChat = () => {
      peerId = document.getElementById("peer").value.trim();
      if (!peerId || peerId === myId) return alert("Invalid ID");
      document.getElementById("setup").style.display = "none";
      loadMessages();
    };

    function getChatId(a,b){return a<b?`${a}_${b}`:`${b}_${a}`;}
    function loadMessages(){
      const q = query(collection(db,"messages"),where("chatId","==",getChatId(myId,peerId)),orderBy("time"),limit(100));
      onSnapshot(q,snap=>{
        messagesDiv.innerHTML="";
        snap.forEach(d=>{const m=d.data();const div=document.createElement("div");div.className=m.sender===myId?"sent":"received";div.textContent=m.text;messagesDiv.appendChild(div);});
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    window.send = async () => {
      const text = input.value.trim();
      if (!text || !peerId) return;
      await addDoc(collection(db,"messages"),{chatId:getChatId(myId,peerId),sender:myId,text,time:serverTimestamp()});
      input.value="";
    };
    input.addEventListener("keypress",e=>e.key==="Enter"&&send());
  </script>
  <style>
    body{font-family:system-ui;background:#000;color:#fff;margin:0;padding:20px;text-align:center}
    #chat{max-width:500px;margin:20px auto;background:#111;padding:20px;border-radius:16px}
    input,button{padding:12px;margin:8px;width:90%;border:none;border-radius:50px;font-size:1em}
    button{background:#00ff9d;color:#000;font-weight:bold;cursor:pointer}
    #messages{height:60vh;overflow-y:auto;background:#000;padding:15px;text-align:left;margin:20px 0}
    .sent{background:#00ff9d;color:#000;padding:10px 16px;border-radius:18px;margin:8px 5px 8px auto;max-width:80%;display:inline-block}
    .received{background:#333;padding:10px 16px;border-radius:18px;margin:8px auto 8px 5px;max-width:80%;display:inline-block}
    h1{color:#00ff9d}
    #myId{background:#222;padding:10px;border-radius:10px;margin:15px;word-break:break-all}
  </style>
</head>
<body>
  <div id="login"><h1>Godray Messenger</h1><p>Loading…</p></div>
  <div id="chat" style="display:none">
    <h1>Godray Messenger</h1>
    <p>Your ID: <span id="myId">…</span></p>
    <div id="setup">
      <input id="peer" placeholder="Friend's ID">
      <button onclick="startChat()">Connect</button>
    </div>
    <div id="messages"></div>
    <input id="msg" placeholder="Type message…">
  </div>
</body>
</html>
