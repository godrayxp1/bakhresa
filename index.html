<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Godray Messenger</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const app = initializeApp({
      apiKey: "AIzaSyB1Dnku0qGEWxLS9R8Mz5neKSReAyuypBs",
      authDomain: "bakhresa-b6176.firebaseapp.com",
      projectId: "bakhresa-b6176",
      storageBucket: "bakhresa-b6176.firebasestorage.app",
      messagingSenderId: "676670596170",
      appId: "1:676670596170:web:e56892493c3e3b69d6b2b3"
    });

    const auth = getAuth(app);
    const db = getFirestore(app);

    let myUsername = "";
    let currentPeer = null;

    const loginScreen = document.getElementById("loginScreen");
    const chatScreen = document.getElementById("chatScreen");
    const usersList = document.getElementById("usersList");
    const chatHeader = document.getElementById("chatHeader");
    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");

    // Login / Register
    window.login = async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("pass").value;
      const username = document.getElementById("username").value.trim().toLowerCase().replace(/[^a-z0-9_]/g, "");

      if (!email || !password || !username) return alert("Fill all fields");

      try {
        let userCred = await signInWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, "users", userCred.user.uid), { username, email, online: true, lastSeen: serverTimestamp() }, { merge: true });
      } catch {
        // Register new user
        let userCred = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, "users", userCred.user.uid), { username, email, online: true, lastSeen: serverTimestamp() });
      }
    };

    // Auth state
    onAuthStateChanged(auth, async user => {
      if (!user) {
        loginScreen.style.display = "block";
        chatScreen.style.display = "none";
        return;
      }
      loginScreen.style.display = "none";
      chatScreen.style.display = "flex";

      const userDoc = await getDoc(doc(db, "users", user.uid));
      myUsername = userDoc.data()?.username || "unknown";
      document.getElementById("myUsername").textContent = "@" + myUsername;

      // Update online status
      await setDoc(doc(db, "users", user.uid), { online: true, lastSeen: serverTimestamp() }, { merge: true });
      window.addEventListener("beforeunload", () => setDoc(doc(db, "users", user.uid), { online: false, lastSeen: serverTimestamp() }, { merge: true }));

      loadUsers();
    });

    // Load all users
    function loadUsers() {
      onSnapshot(collection(db, "users"), snap => {
        usersList.innerHTML = "";
        snap.forEach(d => {
          const u = d.data();
          if (!u.username) return;
          const div = document.createElement("div");
          div.className = "user";
          div.innerHTML = `${u.online ? "ðŸŸ¢" : "âš«"} @${u.username}`;
          div.onclick = () => openChat(u.username);
          usersList.appendChild(div);
        });
      });
    }

    // Open chat with someone
    function openChat(peerUsername) {
      currentPeer = peerUsername;
      chatHeader.textContent = "@" + peerUsername;
      messagesDiv.innerHTML = "";
      loadMessages();
    }

    function getChatId(a, b) { return a < b ? `${a}_${b}` : `${b}_${a}`; }

    function loadMessages() {
      if (!currentPeer) return;
      const chatId = getChatId(myUsername, currentPeer);
      const q = query(collection(db, "messages"), where("chatId", "==", chatId), orderBy("time"));
      onSnapshot(q, snap => {
        messagesDiv.innerHTML = "";
        snap.forEach(d => {
          const m = d.data();
          const div = document.createElement("div");
          div.className = m.from === myUsername ? "sent" : "received";
          div.textContent = m.text;
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    // Send message
    window.send = async () => {
      const text = msgInput.value.trim();
      if (!text || !currentPeer) return;
      const chatId = getChatId(myUsername, currentPeer);
      await addDoc(collection(db, "messages"), {
        chatId,
        from: myUsername,
        to: currentPeer,
        text,
        time: serverTimestamp()
      });
      msgInput.value = "";
    };

    msgInput.addEventListener("keypress", e => e.key === "Enter" && send());
  </script>
  <style>
    body {font-family: system-ui;background:#000;color:#fff;margin:0;height:100vh;display:flex;justify-content:center;align-items:center}
    #loginScreen, #chatScreen {width:100%;max-width:500px;background:#111;padding:30px;border-radius:20px;box-shadow:0 0 40px #00ff9d44}
    input{margin:10px 0;padding:15px;width:100%;border:none;border-radius:50px;background:#222;color:#fff;font-size:1.1em}
    button{padding:15px;width:100%;border:none;border-radius:50px;background:#00ff9d;color:#000;font-weight:bold;font-size:1.1em;cursor:pointer}
    #chatScreen {display:none;flex-direction:column;height:90vh}
    #sidebar {width:30%;background:#000;padding:20px;overflow-y:auto}
    .user {padding:15px;background:#222;margin:8px 0;border-radius:15px;cursor:pointer}
    #main {width:70%;display:flex;flex-direction:column;background:#000}
    #messages {flex:1;overflow-y:auto;padding:20px}
    .sent {background:#00ff9d;color:#000;padding:12px 18px;border-radius:20px;max-width:80%;margin-left:auto;margin-bottom:10px;clear:both;float:right}
    .received {background:#333;padding:12px 18px;border-radius:20px;max-width:80%;margin-right:auto;margin-bottom:10px;clear:both;float:left}
    #inputArea {display:flex;padding:10px;background:#111}
    #msgInput {flex:1;margin-right:10px}
    h1{color:#00ff9d}
  </style>
</head>
<body>

  <!-- Login / Register -->
  <div id="loginScreen">
    <h1>Godray Messenger</h1>
    <input id="email" placeholder="Email" type="email">
    <input id="pass" placeholder="Password" type="password">
    <input id="username" placeholder="Choose username (e.g. godray)">
    <button onclick="login()">Enter Chat</button>
  </div>

  <!-- Main Chat -->
  <div id="chatScreen">
    <div style="text-align:center;padding:10px;background:#000">
      <h1>Godray Messenger</h1>
      <small>You are <b id="myUsername"></b></small>
    </div>
    <div style="display:flex;flex:1;overflow:hidden">
      <div id="sidebar">
        <h3>Online Users</h3>
        <div id="usersList"></div>
      </div>
      <div id="main">
        <h2 id="chatHeader" style="padding:20px;margin:0;background:#111">Click a user to start</h2>
        <div id="messages"></div>
        <div id="inputArea">
          <input id="msgInput" placeholder="Type a messageâ€¦">
          <button onclick="send()">Send</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
