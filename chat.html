<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bakhresa â€¢ Chat</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body {
    margin: 0;
    font-family: system-ui;
    background: linear-gradient(135deg, #020617, #0f172a);
    color: #e5e7eb;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  header {
    padding: 1rem;
    border-bottom: 1px solid #1e293b;
    font-weight: 700;
  }

  #chatBox {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
  }

  .message {
    display: flex;
    gap: 0.6rem;
    margin-bottom: 0.8rem;
    max-width: 85%;
  }

  .own {
    margin-left: auto;
    flex-direction: row-reverse;
  }

  .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #334155;
    object-fit: cover;
  }

  .bubble {
    background: #020617;
    border: 1px solid #1e293b;
    padding: 0.6rem 0.8rem;
    border-radius: 14px;
    font-size: 0.9rem;
  }

  .own .bubble {
    background: #38bdf8;
    color: #020617;
    border: none;
  }

  .username {
    font-size: 0.7rem;
    color: #94a3b8;
    margin-bottom: 2px;
  }

  footer {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem;
    border-top: 1px solid #1e293b;
  }

  input {
    flex: 1;
    padding: 0.6rem 0.9rem;
    border-radius: 999px;
    border: 1px solid #1e293b;
    background: #020617;
    color: #e5e7eb;
    outline: none;
  }

  button {
    padding: 0.6rem 1.1rem;
    border-radius: 999px;
    border: none;
    background: #38bdf8;
    color: #020617;
    font-weight: 600;
    cursor: pointer;
  }
</style>
</head>

<body>

<header>ðŸ’¬ Bakhresa Chat</header>

<div id="chatBox"></div>

<footer>
  <input id="messageInput" placeholder="Type a messageâ€¦" />
  <button id="sendBtn">Send</button>
</footer>

<script>
  /* ======================
     SUPABASE INIT
  ====================== */
  const supabase = window.supabase.createClient(
    "https://osaxbfinrlnabjllcfgv.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zYXhiZmlucmxuYWJqbGxjZmd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1MDY4OTEsImV4cCI6MjA4MTA4Mjg5MX0.qiQzxhYAgd3S_PZUBrT0eYsMfPgSRqP9j7LQq1h4iQE"
  );

  const chatBox = document.getElementById("chatBox");
  const input = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");

  let currentUser;

  /* ======================
     AUTH GUARD
  ====================== */
  async function requireAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      location.replace("index.html");
      return false;
    }
    currentUser = session.user;
    return true;
  }

  /* ======================
     RENDER MESSAGE
  ====================== */
  function renderMessage(msg, profile) {
    const div = document.createElement("div");
    div.className = "message" + (msg.user_id === currentUser.id ? " own" : "");

    div.innerHTML = `
      <img class="avatar" src="${profile?.avatar_url || ''}">
      <div>
        <div class="username">@${profile?.username || "user"}</div>
        <div class="bubble">${msg.content}</div>
      </div>
    `;

    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  /* ======================
     LOAD HISTORY
  ====================== */
  async function loadMessages() {
    const { data, error } = await supabase
      .from("messages")
      .select(`
        id,
        content,
        created_at,
        user_id,
        profiles (
          username,
          avatar_url
        )
      `)
      .order("created_at", { ascending: true });

    if (error) {
      console.error(error);
      return;
    }

    chatBox.innerHTML = "";
    data.forEach(m => renderMessage(m, m.profiles));
  }

  /* ======================
     SEND MESSAGE
  ====================== */
  async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    input.value = "";

    const { error } = await supabase
      .from("messages")
      .insert({
        user_id: currentUser.id,
        content: text
      });

    if (error) console.error(error);
  }

  sendBtn.onclick = sendMessage;
  input.onkeydown = e => e.key === "Enter" && sendMessage();

  /* ======================
     REALTIME SUB
  ====================== */
  function subscribeRealtime() {
    supabase
      .channel("messages-realtime")
      .on(
        "postgres_changes",
        { event: "INSERT", schema: "public", table: "messages" },
        async payload => {
          const { data: profile } = await supabase
            .from("profiles")
            .select("username, avatar_url")
            .eq("id", payload.new.user_id)
            .maybeSingle();

          renderMessage(payload.new, profile);
        }
      )
      .subscribe();
  }

  /* ======================
     INIT
  ====================== */
  (async () => {
    if (await requireAuth()) {
      await loadMessages();
      subscribeRealtime();
    }
  })();
</script>

</body>
</html>