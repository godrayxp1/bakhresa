<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bakhresa â€” Feed</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg: #020617;
      --card: #0f172a;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --border: #1e293b;
    }

    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }

    body { margin: 0; min-height: 100vh; background: linear-gradient(135deg, #020617, #0f172a); color: var(--text); }

    header {
      padding: 1.5rem 2rem; font-weight: 700; font-size: 1.2rem; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }

    .signout { background: transparent; border: 1px solid var(--border); color: var(--muted); padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem; cursor: pointer; }
    .signout:hover { background: var(--border); }

    main { max-width: 680px; margin: 2rem auto; padding: 0 1rem; }

    .composer {
      background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 1rem; margin-bottom: 2rem;
    }

    textarea {
      width: 100%; background: transparent; border: none; color: var(--text); font-size: 1rem; resize: none; outline: none;
      min-height: 60px; max-height: 200px; transition: min-height 0.2s ease;
    }

    textarea:focus { min-height: 100px; }
    textarea::placeholder { color: var(--muted); }

    .composer-footer {
      display: flex; justify-content: space-between; align-items: center; margin-top: 0.8rem;
    }

    .attach-btn {
      background: transparent; border: none; color: var(--accent); cursor: pointer; font-size: 1.3rem;
    }

    .preview-image {
      max-width: 100%; max-height: 300px; border-radius: 12px; margin-top: 0.8rem; object-fit: contain;
    }

    .remove-image {
      position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white;
      border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;
    }

    .char-count { color: var(--muted); font-size: 0.85rem; }

    .post-btn {
      background: var(--accent); color: #020617; border: none; padding: 0.5rem 1rem; border-radius: 8px;
      font-weight: 600; font-size: 0.9rem; cursor: pointer; opacity: 0.6;
    }
    .post-btn.active { opacity: 1; }

    .posts { display: flex; flex-direction: column; gap: 1.5rem; }

    .post {
      background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem;
    }

    .post-header {
      display: flex; align-items: center; gap: 0.8rem; margin-bottom: 0.8rem;
    }

    .avatar {
      width: 42px; height: 42px; border-radius: 50%; object-fit: cover; cursor: pointer;
    }

    .avatar.fallback {
      background: var(--accent); display: grid; place-items: center; font-weight: bold;
      font-size: 1.1rem; color: #020617; cursor: pointer;
    }

    .username {
      font-weight: 600; cursor: pointer;
    }

    .username:hover { color: var(--accent); }

    .timestamp { color: var(--muted); font-size: 0.85rem; }

    .post-content {
      line-height: 1.6; font-size: 1.05rem; margin-top: 0.5rem; white-space: pre-wrap;
    }

    .post-image {
      max-width: 100%; border-radius: 12px; margin-top: 1rem; cursor: pointer;
    }

    .status { text-align: center; padding: 2rem; color: var(--muted); }

    footer { text-align: center; padding: 2rem; font-size: 0.85rem; color: var(--muted); }
  </style>
</head>

<body>
<header>
  <span>Bakhresa</span>
  <button id="signoutBtn" class="signout">Sign out</button>
</header>

<main>
  <div class="composer">
    <textarea id="postInput" placeholder="What's on your mind?"></textarea>
    <div id="imagePreview" style="position:relative; display:none;">
      <img id="previewImg" class="preview-image">
      <button class="remove-image" id="removeImage">Ã—</button>
    </div>
    <div class="composer-footer">
      <button class="attach-btn" id="attachBtn" title="Attach image">ðŸ“Ž</button>
      <input type="file" id="imageInput" accept="image/*" style="display:none;">
      <span class="char-count" id="charCount">0 / 500</span>
      <button id="postBtn" class="post-btn" disabled>Post</button>
    </div>
  </div>

  <div id="postsContainer" class="posts"></div>
  <div id="status" class="status">Loading posts...</div>
</main>

<footer>Auth powered by Supabase â€¢ Â© 2025â€“2026</footer>

<script>
  const supabase = window.supabase.createClient(
    "https://osaxbfinrlnabjllcfgv.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zYXhiZmlucmxuYWJqbGxjZmd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1MDY4OTEsImV4cCI6MjA4MTA4Mjg5MX0.qiQzxhYAgd3S_PZUBrT0eYsMfPgSRqP9j7LQq1h4iQE"
  );

  let currentUser = null;
  let currentUsername = null;
  let currentAvatarUrl = null;
  let selectedImage = null; // File object

  // Auth handling (same as before)
  supabase.auth.onAuthStateChange((_, session) => {
    if (!session) window.location.href = "index.html";
    else init(session.user);
  });

  supabase.auth.getSession().then(({ data }) => {
    if (!data.session) window.location.href = "index.html";
    else init(data.session.user);
  });

  function init(user) {
    currentUser = user;
    currentAvatarUrl = user.user_metadata.avatar_url;
    currentUsername = user.user_metadata.preferred_username || user.user_metadata.login || user.email.split('@')[0];
    loadPosts();
  }

  // Image attachment
  const attachBtn = document.getElementById("attachBtn");
  const imageInput = document.getElementById("imageInput");
  const imagePreview = document.getElementById("imagePreview");
  const previewImg = document.getElementById("previewImg");
  const removeImage = document.getElementById("removeImage");

  attachBtn.addEventListener("click", () => imageInput.click());

  imageInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file || !file.type.startsWith("image/")) return;

    // Compress image client-side
    const compressedBlob = await compressImage(file);
    selectedImage = new File([compressedBlob], file.name, { type: compressedBlob.type });

    previewImg.src = URL.createObjectURL(selectedImage);
    imagePreview.style.display = "block";
    updatePostButton();
  });

  removeImage.addEventListener("click", () => {
    selectedImage = null;
    imagePreview.style.display = "none";
    imageInput.value = "";
    updatePostButton();
  });

  async function compressImage(file) {
    const img = new Image();
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    const bitmap = await createImageBitmap(file);
    let width = bitmap.width;
    let height = bitmap.height;

    // Limit to max 1500px on longest side (good quality, reasonable size)
    if (width > height && width > 1500) {
      height = (height / width) * 1500;
      width = 1500;
    } else if (height > 1500) {
      width = (width / height) * 1500;
      height = 1500;
    }

    canvas.width = width;
    canvas.height = height;
    ctx.drawImage(bitmap, 0, 0, width, height);

    return await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg", 0.85)); // 85% quality JPEG
  }

  // Composer
  const postInput = document.getElementById("postInput");
  const postBtn = document.getElementById("postBtn");
  const charCount = document.getElementById("charCount");

  postInput.addEventListener("input", updatePostButton);

  function updatePostButton() {
    const len = postInput.value.length;
    charCount.textContent = `${len} / 500`;
    const hasContent = len > 0 || selectedImage;
    postBtn.disabled = !hasContent || len > 500;
    postBtn.classList.toggle("active", hasContent && len <= 500);
  }

  postBtn.addEventListener("click", async () => {
    const content = postInput.value.trim();
    if (!content && !selectedImage) return;

    postBtn.disabled = true;
    postBtn.textContent = "Posting...";

    let imagePath = null;

    if (selectedImage) {
      const fileExt = selectedImage.name.split('.').pop();
      const fileName = `${crypto.randomUUID()}.${fileExt}`;
      const { error: uploadError } = await supabase.storage
        .from("post-images")
        .upload(fileName, selectedImage, { upsert: true });

      if (uploadError) {
        alert("Image upload failed: " + uploadError.message);
        postBtn.textContent = "Post";
        postBtn.disabled = false;
        return;
      }
      imagePath = fileName;
    }

    const { error } = await supabase
      .from("posts")
      .insert({ content: content || null, user_id: currentUser.id, image_path: imagePath });

    if (error) alert("Error posting: " + error.message);
    else {
      postInput.value = "";
      selectedImage = null;
      imagePreview.style.display = "none";
      imageInput.value = "";
      updatePostButton();
      loadPosts();
    }

    postBtn.textContent = "Post";
    postBtn.disabled = false;
  });

  // Update posts table (one-time SQL in Supabase editor)
  // ALTER TABLE posts ADD COLUMN image_path TEXT;

  // Load posts
  async function loadPosts() {
    const { data: posts, error } = await supabase
      .from("posts")
      .select("id, content, created_at, user_id, image_path")
      .order("created_at", { ascending: false });

    if (error) {
      document.getElementById("status").textContent = "Error loading posts";
      return;
    }

    const container = document.getElementById("postsContainer");
    container.innerHTML = "";
    document.getElementById("status").style.display = posts.length ? "none" : "block";

    if (!posts.length) {
      document.getElementById("status").textContent = "No posts yet. Be the first!";
      return;
    }

    let profiles = {};
    try {
      const { data } = await supabase.from("profiles").select("id, username, avatar_url");
      data.forEach(p => profiles[p.id] = p);
    } catch (_) {}

    posts.forEach(post => {
      const isMe = post.user_id === currentUser.id;
      const profile = profiles[post.user_id];

      const username = profile?.username || (isMe ? currentUsername : post.user_id.slice(0,8));
      const avatarUrl = profile?.avatar_url || (isMe ? currentAvatarUrl : null);

      const postEl = document.createElement("div");
      postEl.className = "post";

      const timeAgo = timeSince(new Date(post.created_at));

      const avatarHtml = avatarUrl
        ? `<img src="${avatarUrl}" class="avatar" alt="${username}" onerror="this.style.display='none'; this.nextElementSibling.style.display='grid'">`
        + `<div class="avatar fallback" style="display:none">${username[0].toUpperCase()}</div>`
        : `<div class="avatar fallback">${username[0].toUpperCase()}</div>`;

      let imageHtml = "";
      if (post.image_path) {
        const publicUrl = supabase.storage.from("post-images").getPublicUrl(post.image_path).data.publicUrl;
        const transformedUrl = `${publicUrl}?width=800&quality=80`; // On-the-fly optimization
        imageHtml = `<img src="${transformedUrl}" class="post-image" alt="Post image" onclick="window.open('${publicUrl}', '_blank')">`;
      }

      postEl.innerHTML = `
        <div class="post-header">
          <a href="user-details.html?username=${encodeURIComponent(username)}">
            ${avatarHtml}
          </a>
          <div>
            <a href="user-details.html?username=${encodeURIComponent(username)}" style="text-decoration:none; color:inherit;">
              <div class="username">@${username}</div>
            </a>
            <div class="timestamp">${timeAgo}</div>
          </div>
        </div>
        ${post.content ? `<div class="post-content">${escapeHtml(post.content)}</div>` : ""}
        ${imageHtml}
      `;

      container.appendChild(postEl);
    });
  }

  function timeSince(date) {
    const s = Math.floor((Date.now() - date) / 1000);
    if (s < 60) return s + "s";
    if (s < 3600) return Math.floor(s/60) + "m";
    if (s < 86400) return Math.floor(s/3600) + "h";
    if (s < 2592000) return Math.floor(s/86400) + "d";
    if (s < 31536000) return Math.floor(s/2592000) + "mo";
    return Math.floor(s/31536000) + "y";
  }

  function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  document.getElementById("signoutBtn").addEventListener("click", async () => {
    await supabase.auth.signOut();
    window.location.href = "index.html";
  });
</script>
</body>
</html>