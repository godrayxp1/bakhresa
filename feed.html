<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bakhresa — Feed</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --bg:#020617; --card:#0f172a; --text:#e5e7eb;
  --muted:#94a3b8; --accent:#38bdf8; --border:#1e293b;
}

* { box-sizing:border-box; font-family:system-ui; }
body {
  margin:0; background:linear-gradient(135deg,#020617,#0f172a);
  color:var(--text); min-height:100vh;
}

header {
  padding:1.5rem 2rem; font-weight:700;
  border-bottom:1px solid var(--border);
  display:flex; justify-content:space-between;
}

main { max-width:680px; margin:2rem auto; padding:0 1rem; }

.composer {
  background:var(--card); border:1px solid var(--border);
  border-radius:16px; padding:1rem; margin-bottom:2rem;
}

textarea {
  width:100%; background:transparent; border:none;
  color:var(--text); resize:none; outline:none;
  min-height:60px;
}

.posts { display:flex; flex-direction:column; gap:1.5rem; }

.post {
  background:var(--card); border:1px solid var(--border);
  border-radius:16px; padding:1.5rem;
}

.post-header { display:flex; gap:.8rem; align-items:center; }

.avatar {
  width:42px; height:42px; border-radius:50%;
  background:var(--accent); color:#020617;
  display:grid; place-items:center; font-weight:700;
}

.username { font-weight:600; }
.timestamp { font-size:.85rem; color:var(--muted); }

.post-content { margin-top:.5rem; line-height:1.6; }
.post-image { margin-top:1rem; width:100%; border-radius:12px; }

.status { text-align:center; color:var(--muted); padding:2rem; }

/* ---------- SKELETON ---------- */
.skeleton {
  background:linear-gradient(
    90deg,
    #1e293b 25%,
    #334155 37%,
    #1e293b 63%
  );
  background-size:400% 100%;
  animation:shimmer 1.4s ease infinite;
}

@keyframes shimmer {
  0% { background-position:100% 0; }
  100% { background-position:-100% 0; }
}

.skel-avatar { width:42px; height:42px; border-radius:50%; }
.skel-line { height:14px; border-radius:6px; margin-top:8px; }
.skel-image { height:180px; border-radius:12px; margin-top:12px; }
</style>
</head>

<body>
<header>
  <span>Bakhresa</span>
</header>

<main>
  <div class="composer">
    <textarea placeholder="What's on your mind?"></textarea>
  </div>

  <div id="posts" class="posts"></div>
  <div id="status" class="status">Loading posts…</div>
</main>

<script>
const supabase = window.supabase.createClient(
  "https://osaxbfinrlnabjllcfgv.supabase.co",
  "YOUR_ANON_KEY"
);

const postsEl = document.getElementById("posts");
const statusEl = document.getElementById("status");

/* ---------- SKELETON RENDER ---------- */
function showSkeletons(count = 3) {
  postsEl.innerHTML = "";
  for (let i = 0; i < count; i++) {
    const skel = document.createElement("div");
    skel.className = "post";
    skel.innerHTML = `
      <div class="post-header">
        <div class="avatar skeleton skel-avatar"></div>
        <div style="flex:1">
          <div class="skeleton skel-line" style="width:120px"></div>
          <div class="skeleton skel-line" style="width:80px"></div>
        </div>
      </div>
      <div class="skeleton skel-line" style="width:100%"></div>
      <div class="skeleton skel-line" style="width:90%"></div>
      <div class="skeleton skel-image"></div>
    `;
    postsEl.appendChild(skel);
  }
}

/* ---------- LOAD POSTS ---------- */
async function loadPosts() {
  showSkeletons();

  const { data: posts, error } = await supabase
    .from("posts")
    .select("*")
    .order("created_at", { ascending: false })
    .limit(10);

  postsEl.innerHTML = "";

  if (error || !posts.length) {
    statusEl.textContent = "No posts yet.";
    return;
  }

  statusEl.style.display = "none";

  posts.forEach(p => {
    const username = p.user_id ? p.user_id.slice(0,6) : "user";
    const time = new Date(p.created_at).toLocaleString();

    let imageHTML = "";
    if (p.image_path) {
      const url = supabase
        .storage
        .from("post-images")
        .getPublicUrl(p.image_path)
        .data.publicUrl;

      imageHTML = `<img class="post-image" src="${url}">`;
    }

    const post = document.createElement("div");
    post.className = "post";
    post.innerHTML = `
      <div class="post-header">
        <div class="avatar">${username[0].toUpperCase()}</div>
        <div>
          <div class="username">@${username}</div>
          <div class="timestamp">${time}</div>
        </div>
      </div>
      ${p.content ? `<div class="post-content">${escape(p.content)}</div>` : ""}
      ${imageHTML}
    `;
    postsEl.appendChild(post);
  });
}

function escape(text) {
  const d = document.createElement("div");
  d.textContent = text;
  return d.innerHTML;
}

loadPosts();
</script>
</body>
</html>