<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bakhresa â€” Feed</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --bg:#020617; --card:#0f172a; --text:#e5e7eb;
  --muted:#94a3b8; --accent:#38bdf8; --border:#1e293b;
}
*{box-sizing:border-box;font-family:system-ui}
body{margin:0;background:linear-gradient(135deg,#020617,#0f172a);color:var(--text)}
header{padding:1.5rem 2rem;font-weight:700;border-bottom:1px solid var(--border);display:flex;justify-content:space-between}
.signout{background:none;border:1px solid var(--border);color:var(--muted);padding:.5rem 1rem;border-radius:8px;cursor:pointer}
main{max-width:680px;margin:2rem auto;padding:0 1rem}
.posts{display:flex;flex-direction:column;gap:1.5rem}

/* ðŸ”¹ Skeletons */
.skeleton{
  background:linear-gradient(90deg,#0f172a,#1e293b,#0f172a);
  background-size:200% 100%;
  animation:shimmer 1.2s infinite;
  border-radius:12px;
}
@keyframes shimmer{
  from{background-position:200% 0}
  to{background-position:-200% 0}
}
.skel-post{height:180px;padding:1.5rem;border:1px solid var(--border)}
.skel-line{height:14px;margin-top:12px;width:80%}
.skel-avatar{width:42px;height:42px;border-radius:50%}

.post{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.5rem}
.post-header{display:flex;gap:.8rem;align-items:center}
.avatar{width:42px;height:42px;border-radius:50%;object-fit:cover}
.avatar.fallback{background:var(--accent);display:grid;place-items:center;font-weight:700;color:#020617}
.username{font-weight:600;cursor:pointer}
.username:hover{color:var(--accent)}
.timestamp{font-size:.85rem;color:var(--muted)}
.post-content{margin-top:.6rem;line-height:1.6;white-space:pre-wrap}
.post-image{width:100%;border-radius:12px;margin-top:1rem}
.status{text-align:center;color:var(--muted);padding:2rem}
</style>
</head>

<body>
<header>
  <span>Bakhresa</span>
  <button id="signoutBtn" class="signout">Sign out</button>
</header>

<main>
  <div id="postsContainer" class="posts"></div>
  <div id="status" class="status">Loading feedâ€¦</div>
</main>

<script>
const supabase = window.supabase.createClient(
  "https://osaxbfinrlnabjllcfgv.supabase.co",
  "YOUR_ANON_KEY"
);

let currentUser = null;

// ðŸ”¹ AUTH (unchanged, stable)
supabase.auth.onAuthStateChange((_, session)=>{
  if(!session) location.href="index.html";
  else init(session.user);
});
supabase.auth.getSession().then(({data})=>{
  if(!data.session) location.href="index.html";
  else init(data.session.user);
});

function init(user){
  currentUser = user;
  showSkeletons();      // NEW
  loadPosts();
}

/* ðŸ”¹ Skeleton renderer */
function showSkeletons(){
  const c=document.getElementById("postsContainer");
  c.innerHTML="";
  for(let i=0;i<4;i++){
    c.innerHTML+=`
      <div class="post skel-post">
        <div class="skeleton skel-avatar"></div>
        <div class="skeleton skel-line"></div>
        <div class="skeleton skel-line" style="width:60%"></div>
      </div>`;
  }
}

/* ðŸ”¹ Load posts FAST */
async function loadPosts(){
  const {data:posts,error}=await supabase
    .from("posts")
    .select("id,content,created_at,user_id,image_path")
    .order("created_at",{ascending:false})
    .limit(20);

  const container=document.getElementById("postsContainer");
  const status=document.getElementById("status");

  if(error){
    status.textContent="Failed to load feed";
    return;
  }

  if(!posts.length){
    container.innerHTML="";
    status.textContent="No posts yet";
    return;
  }

  status.style.display="none";
  container.innerHTML="";

  // Fetch profiles AFTER rendering posts
  const {data:profiles}=await supabase
    .from("profiles")
    .select("id,username,avatar_url");

  const map={};
  profiles?.forEach(p=>map[p.id]=p);

  posts.forEach(p=>{
    const profile=map[p.user_id];
    const username=profile?.username || p.user_id.slice(0,8);
    const avatar=profile?.avatar_url;

    const img=p.image_path
      ? supabase.storage.from("post-images").getPublicUrl(p.image_path).data.publicUrl
      : null;

    container.innerHTML+=`
      <div class="post">
        <div class="post-header">
          ${
            avatar
            ? `<img src="${avatar}" class="avatar">`
            : `<div class="avatar fallback">${username[0].toUpperCase()}</div>`
          }
          <div>
            <a href="user-details.html?username=${username}" class="username">@${username}</a>
            <div class="timestamp">${timeSince(new Date(p.created_at))}</div>
          </div>
        </div>
        ${p.content?`<div class="post-content">${escapeHtml(p.content)}</div>`:""}
        ${img?`<img loading="lazy" src="${img}" class="post-image">`:""}
      </div>`;
  });
}

function timeSince(d){
  const s=(Date.now()-d)/1000;
  if(s<60)return Math.floor(s)+"s";
  if(s<3600)return Math.floor(s/60)+"m";
  if(s<86400)return Math.floor(s/3600)+"h";
  return Math.floor(s/86400)+"d";
}
function escapeHtml(t){
  const d=document.createElement("div");
  d.textContent=t; return d.innerHTML;
}

document.getElementById("signoutBtn").onclick=async()=>{
  await supabase.auth.signOut();
  location.href="index.html";
};
</script>
</body>
</html>